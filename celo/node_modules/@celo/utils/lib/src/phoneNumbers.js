"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
var country_data_1 = __importDefault(require("country-data"));
var google_libphonenumber_1 = require("google-libphonenumber");
var Web3Utils = __importStar(require("web3-utils"));
var phoneUtil = google_libphonenumber_1.PhoneNumberUtil.getInstance();
var MIN_PHONE_LENGTH = 4;
function getCountryEmoji(e164PhoneNumber, countryCodePossible, regionCodePossible) {
    // The country code and region code can both be passed in, or it can be inferred from the e164PhoneNumber
    var countryCode;
    var regionCode;
    countryCode = countryCodePossible;
    regionCode = regionCodePossible;
    if (!countryCode || !regionCode) {
        countryCode = getCountryCode(e164PhoneNumber);
        regionCode = getRegionCode(e164PhoneNumber);
    }
    var countries = country_data_1.default.lookup.countries({ countryCallingCodes: "+" + countryCode });
    var userCountryArray = countries.filter(function (c) { return c.alpha2 === regionCode; });
    var country = userCountryArray.length > 0 ? userCountryArray[0] : undefined;
    return (country ? country.emoji : '') + (" +" + countryCode);
}
exports.getCountryEmoji = getCountryEmoji;
exports.getPhoneHash = function (phoneNumber) {
    if (!phoneNumber || !isE164Number(phoneNumber)) {
        throw Error('Attempting to hash a non-e164 number: ' + phoneNumber);
    }
    return Web3Utils.soliditySha3({ type: 'string', value: phoneNumber });
};
function getCountryCode(e164PhoneNumber) {
    if (!e164PhoneNumber) {
        return null;
    }
    try {
        return phoneUtil.parse(e164PhoneNumber).getCountryCode();
    }
    catch (error) {
        console.debug("getCountryCode, number: " + e164PhoneNumber + ", error: " + error);
        return null;
    }
}
exports.getCountryCode = getCountryCode;
function getRegionCode(e164PhoneNumber) {
    if (!e164PhoneNumber) {
        return null;
    }
    try {
        return phoneUtil.getRegionCodeForNumber(phoneUtil.parse(e164PhoneNumber));
    }
    catch (error) {
        console.debug("getRegionCodeForNumber, number: " + e164PhoneNumber + ", error: " + error);
        return null;
    }
}
exports.getRegionCode = getRegionCode;
function getRegionCodeFromCountryCode(countryCode) {
    if (!countryCode) {
        return null;
    }
    try {
        return phoneUtil.getRegionCodeForCountryCode(parseInt(countryCode, 10));
    }
    catch (error) {
        console.debug("getRegionCodeFromCountryCode, countrycode: " + countryCode + ", error: " + error);
        return null;
    }
}
exports.getRegionCodeFromCountryCode = getRegionCodeFromCountryCode;
function getDisplayPhoneNumber(phoneNumber, defaultCountryCode) {
    var phoneDetails = parsePhoneNumber(phoneNumber, defaultCountryCode);
    if (phoneDetails) {
        return phoneDetails.displayNumber;
    }
    else {
        // Fallback to input instead of showing nothing for invalid numbers
        return phoneNumber;
    }
}
exports.getDisplayPhoneNumber = getDisplayPhoneNumber;
function getE164DisplayNumber(e164PhoneNumber) {
    var countryCode = getCountryCode(e164PhoneNumber);
    return getDisplayPhoneNumber(e164PhoneNumber, (countryCode || '').toString());
}
exports.getE164DisplayNumber = getE164DisplayNumber;
function getE164Number(phoneNumber, defaultCountryCode) {
    var phoneDetails = parsePhoneNumber(phoneNumber, defaultCountryCode);
    if (phoneDetails && isE164Number(phoneDetails.e164Number)) {
        return phoneDetails.e164Number;
    }
    else {
        return null;
    }
}
exports.getE164Number = getE164Number;
function isE164Number(phoneNumber) {
    var E164RegEx = /^\+[1-9][0-9]{1,14}$/;
    return E164RegEx.test(phoneNumber);
}
exports.isE164Number = isE164Number;
function parsePhoneNumber(phoneNumberRaw, defaultCountryCode) {
    try {
        if (!phoneNumberRaw || phoneNumberRaw.length < MIN_PHONE_LENGTH) {
            return null;
        }
        var defaultRegionCode = getRegionCodeFromCountryCode(defaultCountryCode);
        var parsedNumberUnfixed = phoneUtil.parse(phoneNumberRaw, defaultRegionCode || undefined);
        var parsedCountryCode = parsedNumberUnfixed.getCountryCode();
        var parsedRegionCode = phoneUtil.getRegionCodeForNumber(parsedNumberUnfixed);
        var parsedNumber = handleSpecialCasesForParsing(parsedNumberUnfixed, parsedCountryCode, parsedRegionCode);
        if (!parsedNumber) {
            return null;
        }
        var isValid = phoneUtil.isValidNumberForRegion(parsedNumber, parsedRegionCode);
        return isValid
            ? {
                e164Number: phoneUtil.format(parsedNumber, google_libphonenumber_1.PhoneNumberFormat.E164),
                displayNumber: handleSpecialCasesForDisplay(parsedNumber, parsedCountryCode),
                countryCode: parsedCountryCode,
                regionCode: parsedRegionCode,
            }
            : null;
    }
    catch (error) {
        console.debug("phoneNumbers/parsePhoneNumber/Failed to parse phone number, error: " + error);
        return null;
    }
}
exports.parsePhoneNumber = parsePhoneNumber;
function handleSpecialCasesForParsing(parsedNumber, countryCode, regionCode) {
    if (!countryCode || !regionCode) {
        return parsedNumber;
    }
    switch (countryCode) {
        // Argentina
        // https://github.com/googlei18n/libphonenumber/blob/master/FAQ.md#why-is-this-number-from-argentina-ar-or-mexico-mx-not-identified-as-the-right-number-type
        // https://en.wikipedia.org/wiki/Telephone_numbers_in_Argentina
        case 54:
            return prependToFormMobilePhoneNumber(parsedNumber, regionCode, '9');
        // Mexico
        // https://github.com/googlei18n/libphonenumber/blob/master/FAQ.md#why-is-this-number-from-argentina-ar-or-mexico-mx-not-identified-as-the-right-number-type
        // https://en.wikipedia.org/wiki/Telephone_numbers_in_Mexico
        case 52:
            return prependToFormMobilePhoneNumber(parsedNumber, regionCode, '1');
        default:
            return parsedNumber;
    }
}
// TODO(Rossy) Given the inconsistencies of numbers around the world, we should
// display e164 everywhere to ensure users knows exactly who their sending money to
function handleSpecialCasesForDisplay(parsedNumber, countryCode) {
    switch (countryCode) {
        // Argentina
        // The Google lib formatter incorretly adds '15' to the nationally formatted number for Argentina
        // However '15' is only needed when calling a mobile from a landline
        case 54:
            return phoneUtil
                .format(parsedNumber, google_libphonenumber_1.PhoneNumberFormat.INTERNATIONAL)
                .replace(/\+54(\s)?/, '');
        default:
            return phoneUtil.format(parsedNumber, google_libphonenumber_1.PhoneNumberFormat.NATIONAL);
    }
}
/**
 * Some countries require a prefix before the area code depending on if the number is
 * mobile vs landline and international vs national
 */
function prependToFormMobilePhoneNumber(parsedNumber, regionCode, prefix) {
    if (phoneUtil.getNumberType(parsedNumber) === google_libphonenumber_1.PhoneNumberType.MOBILE) {
        return parsedNumber;
    }
    var nationalNumber = phoneUtil.format(parsedNumber, google_libphonenumber_1.PhoneNumberFormat.NATIONAL);
    // Nationally formatted numbers sometimes contain leading 0
    if (nationalNumber.charAt(0) === '0') {
        nationalNumber = nationalNumber.slice(1);
    }
    // If the number already starts with prefix, don't prepend it again
    if (nationalNumber.startsWith(prefix)) {
        return null;
    }
    var adjustedNumber = phoneUtil.parse(prefix + nationalNumber, regionCode);
    return phoneUtil.getNumberType(adjustedNumber) === google_libphonenumber_1.PhoneNumberType.MOBILE ? adjustedNumber : null;
}
function anonymizedPhone(phoneNumber) {
    return phoneNumber.slice(0, -4) + 'XXXX';
}
exports.anonymizedPhone = anonymizedPhone;
exports.PhoneNumberUtils = {
    getPhoneHash: exports.getPhoneHash,
    getCountryCode: getCountryCode,
    getRegionCode: getRegionCode,
    getDisplayPhoneNumber: getDisplayPhoneNumber,
    getE164Number: getE164Number,
    isE164Number: isE164Number,
    parsePhoneNumber: parsePhoneNumber,
};
